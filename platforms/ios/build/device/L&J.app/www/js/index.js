// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var append_picture, channel, compare_pictures, createGallery, fail, generate_html_elm, infiniteScrolling, insert_pictures, is_gallery_set, is_overlay_shown, onFail, prepend_picture, pusher, removeGalleryIfPresent, remove_clicked_color, showMorePictures, takePicture, uploadPictureFromLibrary, upload_picture, win;
    window.pictures_data = [];
    window.pictures_data_dict = [];
    window.current_start_index = 0;
    window.gallery = null;
    is_overlay_shown = function() {
      return $('.ps-carousel').length > 0;
    };
    is_gallery_set = function() {
      return typeof window.gallery !== "undefined" && window.gallery !== null;
    };
    createGallery = function() {
      if (is_overlay_shown()) {
        console.log("Not create gallery");
        if (is_gallery_set()) {
          return window.gallery.addEventHandler(window.Code.PhotoSwipe.EventTypes.onHide, function(e) {
            console.log("Returning from hiding.");
            removeGalleryIfPresent();
            return createGallery();
          });
        }
      } else {
        console.log("Setting up gallery");
        window.gallery = $("#Gallery a").photoSwipe({
          enableKeyboard: false,
          enableMouseWheel: false
        });
        return $(window).scroll(infiniteScrolling);
      }
    };
    removeGalleryIfPresent = function() {
      if (is_overlay_shown()) {
        return console.log("Gallery overlay shown already.");
      } else if (is_gallery_set()) {
        console.log('Removing gallery');
        window.Code.PhotoSwipe.unsetActivateInstance(window.gallery);
        window.Code.PhotoSwipe.detatch(window.gallery);
        return window.gallery = null;
      }
    };
    insert_pictures = function(data, textStatus, jqXHR) {
      window.pictures_data = data;
      window.pictures_data_dict = data.toDict('id');
      window.current_start_index = data.length - 1;
      return showMorePictures();
    };
    showMorePictures = function() {
      var end, index, picture, start, _i;
      if (window.current_start_index > 0) {
        removeGalleryIfPresent();
        end = window.current_start_index;
        start = Math.max(0, end - 15);
        window.current_start_index = start;
        for (index = _i = end; end <= start ? _i <= start : _i >= start; index = end <= start ? ++_i : --_i) {
          picture = window.pictures_data[index];
          append_picture(picture);
        }
        createGallery();
        if (start === 0) {
          $('#picture_loading').hide();
          return $('#picture_end').show();
        }
      }
    };
    Array.prototype.toDict = function(key) {
      return this.reduce((function(dict, obj) {
        if (obj[key] != null) {
          dict[obj[key]] = obj;
        }
        return dict;
      }), {});
    };
    compare_pictures = function(data, textStatus, jqXHR) {
      var picture, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        picture = data[_i];
        if (typeof window.pictures_data_dict[picture.id] === "undefined") {
          prepend_picture(picture);
          window.pictures_data.push(picture);
          _results.push(window.pictures_data_dict[picture.id] = picture);
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };
    window.get_act_code = function() {
      return window.localStorage.getItem('act_code');
    };
    window.update_pictures = function(act_code) {
      var url;
      console.log('resuming');
      url = 'http://www.lineogjakob.dk/images.json?act_code=' + act_code;
      return $.get(url, compare_pictures);
    };
    window.deviceReady = function() {
      var act_code;
      console.log("Version is " + window.device.version);
      if (window.device.version.substring(0, 1) === '7') {
        $('#pictures').css('margin-top', '20px');
        $('#pictures-toolbar').css('margin-top', '20px');
      }
      window.load_pictures_fun = function(act_code) {
        var update_pictures, url;
        console.log("Loading pictures.");
        $('.activation_code_msg').hide();
        url = 'http://www.lineogjakob.dk/images.json?act_code=' + act_code;
        $.get(url, insert_pictures);
        update_pictures = function() {
          return window.update_pictures(act_code);
        };
        document.addEventListener("resume", update_pictures, false);
        return document.addEventListener("online", update_pictures, false);
      };
      act_code = window.get_act_code();
      if (act_code) {
        return window.load_pictures_fun(act_code);
      }
    };
    prepend_picture = function(picture) {
      var li_elm;
      li_elm = generate_html_elm(picture);
      return $(li_elm).clone().hide().prependTo($('#Gallery')).slideDown();
    };
    append_picture = function(picture) {
      var li_elm;
      li_elm = generate_html_elm(picture);
      return $(li_elm).clone().hide().appendTo($('#Gallery')).slideDown();
    };
    generate_html_elm = function(data) {
      var anchor_elm, img_elm, li_elm, medium_thumb_url, small_thumb_url, title;
      console.log("Prepending is: " + data);
      small_thumb_url = "http://www.lineogjakob.dk" + data.small_thumb_url;
      medium_thumb_url = "http://www.lineogjakob.dk" + data.medium_thumb_url;
      title = "Taget af " + data.guest.first_name;
      if (data.guest.last_name) {
        title += " " + data.guest.last_name.substring(0, 1) + ".";
      }
      console.log("Creating elements.");
      img_elm = document.createElement('img');
      img_elm.src = small_thumb_url;
      img_elm.alt = title;
      anchor_elm = document.createElement('a');
      anchor_elm.href = medium_thumb_url;
      anchor_elm.ref = 'external';
      anchor_elm.appendChild(img_elm);
      li_elm = document.createElement('li');
      li_elm.appendChild(anchor_elm);
      console.log("Returning the picture.");
      return li_elm;
    };
    win = function(response) {
      console.log("Code = " + response.responseCode);
      console.log("Response = " + response.response);
      return console.log("Sent = " + response.bytesSent);
    };
    fail = function(error) {
      console.log("upload error source " + error.source);
      return console.log("upload error target " + error.target);
    };
    upload_picture = function(image_url) {
      var ft, liitem, options, params;
      console.log("uploading picture: " + image_url);
      options = new FileUploadOptions();
      options.fileKey = "image[image]";
      options.fileName = image_url.substr(image_url.lastIndexOf('/') + 1);
      options.mimeType = "image/jpeg";
      params = new Object();
      params.act_code = window.get_act_code();
      params['image[name]'] = "From mobilephone";
      options.params = params;
      liitem = document.createElement('li');
      $('.status_bar').append(liitem);
      ft = new FileTransfer();
      ft.onprogress = function(progressEvent) {
        var perc;
        if (progressEvent.lengthComputable) {
          perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
          return liitem.innerHTML = perc + "% uploaded...";
        } else {
          if (liitem.innerHTML === "") {
            return liitem.innerHTML = "Uploading";
          } else {
            return liitem.innerHTML += ".";
          }
        }
      };
      ft.upload(image_url, encodeURI("http://www.lineogjakob.dk/images.json"), (function(r) {
        $(liitem).remove();
        return win(r);
      }), (function(r) {
        $(liitem).remove();
        return fail(r);
      }), options);
      return console.log("Started the upload.");
    };
    onFail = function(message) {
      return console.log('Failed because: ' + message);
    };
    remove_clicked_color = function() {
      return $('.picture_buttons a').removeClass('ui-btn-active');
    };
    takePicture = function() {
      navigator.camera.getPicture(upload_picture, onFail, {
        quality: 75,
        targetWidth: 1600,
        targetHeight: 1600,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: navigator.camera.PictureSourceType.CAMERA,
        saveToPhotoAlbum: true,
        correctOrientation: true
      });
      return remove_clicked_color();
    };
    uploadPictureFromLibrary = function() {
      navigator.camera.getPicture(upload_picture, onFail, {
        quality: 75,
        targetWidth: 1600,
        targetHeight: 1600,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY
      });
      return remove_clicked_color();
    };
    $('#take_picture_button').click(function() {
      console.log("Taking picture.");
      return takePicture();
    });
    $('#upload_picture_button').click(function() {
      console.log("Uploading picture.");
      return uploadPictureFromLibrary();
    });
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        return window.console.log(message);
      }
    };
    pusher = new Pusher('542416e0dcbaf6b1fb39');
    channel = pusher.subscribe('pictures');
    channel.bind('new_picture', function(data) {
      var picture;
      removeGalleryIfPresent();
      picture = $.parseJSON(data.message);
      prepend_picture(picture);
      window.pictures_data.push(picture);
      window.pictures_data_dict[picture.id] = picture;
      return createGallery();
    });
    return infiniteScrolling = function() {
      if ($.mobile.activePage.attr("id") !== "pictures") {
        return;
      }
      if (!($(window).scrollTop() === 0) && $(window).scrollTop() + 20 >= $(document).height() - $(window).height()) {
        console.log("Scrolling and showing more pictures...");
        return showMorePictures();
      }
    };
  });

  document.addEventListener('deviceready', window.deviceReady, false);

  $(function() {
    var loadURL;
    loadURL = function(url) {
      navigator.app.loadUrl(url, {
        openExternal: true
      });
      return false;
    };
    return $('.external_link').live('click', function() {
      var url;
      url = $(this).attr("rel");
      window.open(url, '_blank');
      return false;
    });
  });

}).call(this);
