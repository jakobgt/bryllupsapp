// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    var append_picture, channel, createGallery, fail, generate_html_elm, infiniteScrolling, insert_pictures, onFail, prepend_picture, pusher, removeGalleryIfPresent, remove_clicked_color, showMorePictures, takePicture, uploadPictureFromLibrary, upload_picture, win;
    window.pictures_data = [];
    window.current_start_index = 0;
    createGallery = function() {
      console.log("Setting up gallery");
      return window.gallery = $("#Gallery a").photoSwipe({
        enableKeyboard: false,
        enableMouseWheel: false
      });
    };
    removeGalleryIfPresent = function() {
      if (typeof window.gallery !== "undefined" && window.gallery !== null) {
        console.log('Removing gallery');
        window.Code.PhotoSwipe.unsetActivateInstance(window.gallery);
        window.Code.PhotoSwipe.detatch(window.gallery);
        return window.gallery = null;
      }
    };
    insert_pictures = function(data, textStatus, jqXHR) {
      window.pictures_data = data;
      window.current_start_index = data.length - 1;
      return showMorePictures();
    };
    showMorePictures = function() {
      var end, picture, start, _i, _len, _ref;
      if (window.current_start_index > 0) {
        removeGalleryIfPresent();
        end = window.current_start_index;
        start = Math.max(0, end - 10);
        window.current_start_index = start;
        _ref = window.pictures_data.slice(start, +end + 1 || 9e9);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          picture = _ref[_i];
          append_picture(picture);
        }
        createGallery();
        if (start === 0) {
          $('#picture_loading').hide();
          return $('#picture_end').show();
        }
      }
    };
    window.deviceReady = function() {
      console.log("Loading pictures.");
      return $.get('http://www.lineogjakob.dk/images.json', insert_pictures);
    };
    prepend_picture = function(picture) {
      var li_elm;
      li_elm = generate_html_elm(picture);
      return $(li_elm).clone().hide().prependTo($('#Gallery')).slideDown();
    };
    append_picture = function(picture) {
      var li_elm;
      li_elm = generate_html_elm(picture);
      return $(li_elm).clone().hide().appendTo($('#Gallery')).slideDown();
    };
    generate_html_elm = function(data) {
      var anchor_elm, img_elm, li_elm, medium_thumb_url, small_thumb_url, title;
      console.log("Date is: " + data);
      small_thumb_url = "http://www.lineogjakob.dk" + data.small_thumb_url;
      medium_thumb_url = "http://www.lineogjakob.dk" + data.medium_thumb_url;
      title = "Fra: " + data.guest.first_name;
      if (data.guest.last_name) {
        title += " " + data.guest.last_name.substring(0, 1) + ".";
      }
      console.log("Creating elements.");
      img_elm = document.createElement('img');
      img_elm.src = small_thumb_url;
      img_elm.alt = title;
      anchor_elm = document.createElement('a');
      anchor_elm.href = medium_thumb_url;
      anchor_elm.ref = 'external';
      anchor_elm.appendChild(img_elm);
      li_elm = document.createElement('li');
      li_elm.appendChild(anchor_elm);
      console.log("Returning the picture.");
      return li_elm;
    };
    win = function(response) {
      console.log("Code = " + response.responseCode);
      console.log("Response = " + response.response);
      return console.log("Sent = " + response.bytesSent);
    };
    fail = function(error) {
      console.log("upload error source " + error.source);
      return console.log("upload error target " + error.target);
    };
    upload_picture = function(image_url) {
      var ft, liitem, options, params;
      console.log("uploading picture: " + image_url);
      options = new FileUploadOptions();
      options.fileKey = "image[image]";
      options.fileName = image_url.substr(image_url.lastIndexOf('/') + 1);
      options.mimeType = "image/jpeg";
      params = new Object();
      params.act_code = "vgyukm";
      params['image[name]'] = "From mobilephone";
      options.params = params;
      liitem = document.createElement('li');
      $('.status_bar').append(liitem);
      ft = new FileTransfer();
      ft.onprogress = function(progressEvent) {
        var perc;
        if (progressEvent.lengthComputable) {
          perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
          return liitem.innerHTML = perc + "% uploaded...";
        } else {
          if (liitem.innerHTML === "") {
            return liitem.innerHTML = "Uploading";
          } else {
            return liitem.innerHTML += ".";
          }
        }
      };
      ft.upload(image_url, encodeURI("http://www.lineogjakob.dk/images.json"), (function(r) {
        $(liitem).remove();
        return win(r);
      }), (function(r) {
        $(liitem).remove();
        return fail(r);
      }), options);
      return console.log("Started the upload.");
    };
    onFail = function(message) {
      return console.log('Failed because: ' + message);
    };
    remove_clicked_color = function() {
      return $('.picture_buttons a').removeClass('ui-btn-active');
    };
    takePicture = function() {
      navigator.camera.getPicture(upload_picture, onFail, {
        quality: 75,
        targetWidth: 1600,
        targetHeight: 1600,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: navigator.camera.PictureSourceType.CAMERA,
        saveToPhotoAlbum: true,
        correctOrientation: true
      });
      return remove_clicked_color();
    };
    uploadPictureFromLibrary = function() {
      navigator.camera.getPicture(upload_picture, onFail, {
        quality: 75,
        targetWidth: 1600,
        targetHeight: 1600,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY
      });
      return remove_clicked_color();
    };
    $('#take_picture_button').click(function() {
      console.log("Taking picture.");
      return takePicture();
    });
    $('#upload_picture_button').click(function() {
      console.log("Uploading picture.");
      return uploadPictureFromLibrary();
    });
    Pusher.log = function(message) {
      if (window.console && window.console.log) {
        return window.console.log(message);
      }
    };
    pusher = new Pusher('542416e0dcbaf6b1fb39');
    channel = pusher.subscribe('pictures');
    channel.bind('new_picture', function(data) {
      removeGalleryIfPresent();
      prepend_picture($.parseJSON(data.message));
      window.pictures_data.push(data);
      return createGallery();
    });
    infiniteScrolling = function() {
      if ($.mobile.activePage.attr("id") !== "pictures") {
        return;
      }
      if (!($(window).scrollTop() === 0) && $(window).scrollTop() >= $(document).height() - $(window).height()) {
        console.log("Scrolling and showing more pictures...");
        showMorePictures();
        return $(window).scroll(infiniteScrolling);
      }
    };
    return $(window).scroll(infiniteScrolling);
  });

  document.addEventListener('deviceready', window.deviceReady, false);

}).call(this);
